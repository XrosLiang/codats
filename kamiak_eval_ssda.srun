#!/bin/bash
#SBATCH --job-name=eval
#SBATCH --output=slurm_logs/eval_%A_%a.out
#SBATCH --error=slurm_logs/eval_%A_%a.err
#SBATCH --cpus-per-task=1
#SBATCH --gres=gpu:1
#SBATCH --partition=cook,free_gpu,cahnrs_gpu,kamiak
#SBATCH --time=0-01:00:00
#SBATCH --mem=20G
#SBATCH --array=0-299

. kamiak_config.sh
. kamiak_tensorflow_gpu.sh
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

# Errors
handle_terminate() { echo "Exiting"; exit 1; }
handle_error() { echo "Error occurred -- exiting"; exit 1; }
trap "handle_terminate" SIGTERM SIGINT

# Get suffix, i.e. files stored in kamiak-{models,logs}-suffix
suffix=$1; shift
[[ -z $suffix ]] && { echo "no suffix specified"; handle_error; }

methods=("dann_hda" "dann_pad" "dann_drop" "none_pad" "none_drop")
variants=("best_target")
# number of adaptation problems = 60
uids=(0 1 2 3 4 5_0 5_1 5_2 5_3 5_4 5 6 7 8 9 10_0 10_1 10_2 10_3 10_4 10 11 12 13 14 15_0 15_1 15_2 15_3 15_4 0 1 2 3 4 5_0 5_1 5_2 5_3 5_4 5 6 7 8 9 10_0 10_1 10_2 10_3 10_4 10 11 12 13 14 15_0 15_1 15_2 15_3 15_4)
datasets=("ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar" "ucihhar")
sources=("14" "12" "18" "17" "7" "9" "12" "6" "2" "7" "14" "12" "18" "17" "7" "9" "12" "6" "2" "7" "14" "12" "18" "17" "7" "9" "12" "6" "2" "7" "1" "1" "0" "4" "5" "2" "5" "3" "3" "4" "1" "1" "0" "4" "5" "2" "5" "3" "3" "4" "1" "1" "0" "4" "5" "2" "5" "3" "3" "4")
targets=("19" "16" "23" "25" "24" "18" "18" "23" "11" "13" "19" "16" "23" "25" "24" "18" "18" "23" "11" "13" "19" "16" "23" "25" "24" "18" "18" "23" "11" "13" "3" "6" "6" "6" "8" "7" "6" "8" "5" "5" "3" "6" "6" "6" "8" "7" "6" "8" "5" "5" "3" "6" "6" "6" "8" "7" "6" "8" "5" "5")
args=("--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2" "--source_feature_subset=0,1 --target_feature_subset=0,1,2")

# Make sure we're using the right number
correct_min=0
correct_max=$(( ${#methods[@]} * ${#variants[@]} * ${#sources[@]} - 1))
[[ ${#sources[@]} == ${#targets[@]} ]] || \
    { echo "source/target sizes should match"; handle_error; }
[[ ${#sources[@]} == ${#uids[@]} ]] || \
    { echo "length of sources and uids arrays differ"; handle_error; }
[[ ${#sources[@]} == ${#datasets[@]} ]] || \
    { echo "length of sources and datasets arrays differ"; handle_error; }
[[ $SLURM_ARRAY_TASK_MIN == $correct_min ]] || \
    { echo "array min should be $correct_min"; handle_error; }
[[ $SLURM_ARRAY_TASK_MAX == $correct_max ]] || \
    { echo "array max should be $correct_max"; handle_error; }

# Indexing: https://stackoverflow.com/a/34363187
index=$SLURM_ARRAY_TASK_ID
index1max=${#sources[@]}
index2max=${#variants[@]}
index3=$((index / (index1max * index2max)))
index=$((index - index3 * index1max * index2max))
index2=$((index / index1max))
index1=$((index % index1max))

method="${methods[$index3]}"
variant="${variants[$index2]}"
uid="${uids[$index1]}"
dataset_name="${datasets[$index1]}"
source="${sources[$index1]}"
target="${targets[$index1]}"
other_args="${args[$index1]}"

# Output name uses method from above not the "none" for "upper"
out="results/results_${suffix}_$variant-$dataset_name-$uid-$method.yaml"

# Upper bound is actually "none" but without a target domain and with other args
additional_args=()
if [[ $method == "upper" ]]; then
    method="none"
    source="$target"
    target=""
fi

echo "$suffix #$SLURM_ARRAY_TASK_ID"
echo "Selection: $variant"
echo "Method: $method"
echo "Other args: $other_args ${additional_args[@]} $@"
echo "UID: $uid"
echo "$dataset_name $source --> $target"

cd "$remotedir"
mkdir -p results
# Note: don't quote $other_args since it may have spaces between arguments in it
python3 main_eval.py \
    --logdir="$logFolder-$suffix" --modeldir="$modelFolder-$suffix" \
    --jobs=1 --gpus=1 --gpumem=0 \
    --match="${dataset_name}-${uid}-${method}-[0-9]*" \
    --selection="$variant" --output_file="$out" \
    $other_args "${additional_args[@]}" "$@" || handle_error
